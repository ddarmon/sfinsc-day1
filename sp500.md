# S&P 500 Correlation Networks

In this example, we will analyze a network constructed from associations in the log returns of stocks listed on the [Standard & Poor's 500](https://en.wikipedia.org/wiki/S%26P_500_Index).

## The Data

The data consists of the closing prices of the companies included in the S&P 500 Index over three periods: from 2003 to 2007, from 2008 to 2012, and from 2013 to 2016. For example, the here are the closing prices for Ventas (VTR) and Simon Property Group (SPG), two real estate companies, from January 1st, 2003 to December 31st, 2007:

<p align="center">
<img src="https://raw.githubusercontent.com/ddarmon/sfinsc-day1/master/graphics/stocks-raw-max-corr.png">
</p>

As we can see, the stock prices for these two companies tend to move in a similar direction. For each company in the S&P 500, we have a time series of their closing prices over time. Our goal is to gain an understanding of the organization of the companies in the S&P 500 based on the co-movement of their stocks. For example, we know that a high default rate amongst subprime home mortage holders in 2007 contributed to the [2008 financial crisis](https://en.wikipedia.org/wiki/Financial_crisis_of_2007%E2%80%932008), which impacted the real estate, mortgage, and banking industries. Thus, we would expect companies in these sectors to be highly associated over time, with weaker associations to companies outside of these sectors.

When working with stock market data, it is common to consider the log rate of return for a stock rather than the raw stock price itself. That is, if the closing price on day *t* is *P<sub>t</sub>*, then the log rate of return *P<sub>t</sub>* is

<p align="center">
<img src="https://raw.githubusercontent.com/ddarmon/sfinsc-day2/master/graphics/eq-log-return.png">
</p>

Here are the log rates of returns for Ventas (VTR) and Simon Property Group (SPG):

<p align="center">
<img src="https://raw.githubusercontent.com/ddarmon/sfinsc-day1/master/graphics/stocks-logreturn-max-corr.png">
</p>

We still see a clear association between the two companies: when log return is positive / negative for one, it is positive / negative for the other, and vice versa. One nice way to inspect this relationship is to consider the scatter plot of the log returns of VTR on a particular day against the log returns of SPG on a particular day:

<p align="center">
<img src="https://raw.githubusercontent.com/ddarmon/sfinsc-day1/master/graphics/stocks-corrplot-max-corr.png">
</p>

Each point here corresponds to a particular day, and we see graphically the association between the two companies' log returns. For a linear relationship like this, we can summarize the relationship between the companies using [Pearson correlation](https://en.wikipedia.org/wiki/Pearson_correlation_coefficient). For these two companies, the correlation between their log returns is 0.84.

Contrast this with another pair of companies, Berkshire Hathaway (BRK) and BlackRock (BLK). Their closing prices, log rate of returns, and scatter plots are shown below:

<p align="center">
<img src="https://raw.githubusercontent.com/ddarmon/sfinsc-day1/master/graphics/stocks-raw-min-corr.png">
</p>

<p align="center">
<img src="https://raw.githubusercontent.com/ddarmon/sfinsc-day1/master/graphics/stocks-logreturn-min-corr.png">
</p>

<p align="center">
<img src="https://raw.githubusercontent.com/ddarmon/sfinsc-day1/master/graphics/stocks-corrplot-min-corr.png">
</p>



> **Exercise:**

## Data Cleaning

We will be investigating networks constructed via pairwise correlations between the log returns of each company in the data set. Correlations can be very sensitive to outliers in a data set, and thus we first [Winsorize](https://en.wikipedia.org/wiki/Winsorizing) the log return time series for each company before computing correlations.

Many statistical procedures have assumptions 

> **Exercise:** Load the correlation network ``sp500_network.txt`` into Gephi as an undirected, weighted network where the weight on an edge between two companies corresponds to their correlation over the XYZ year period.

> **Exercise:** Copy over the company names as the labels for the nodes.

## Network Construction

The network itself is stored in ``sp500_network.txt`` as an annotated edge list, for example line 2

> A,AAP,Undirected,0.376600

says that there is an undirected edge between A (Agilent Technologies)  and AAP (Advance Auto Parts), and the pairwise correlation between their log stock returns was 0.376600.

> **Exercise:** Load the network into gephi by going to File > Import spreadsheet... PUT INFO / FIGURES HERE ON HOW TO SET THE OPTIONS FOR IMPORTING THE NETWORK.

## Network Analysis

Because there is an edge between each node in the network (we have computed a pairwise correlation between each pair of log returns), the network is dense: for 434 nodes, there are the full 93961 edges possible.

> **Exercise**: How do you determine the number of edges in an N node network? Hint: count the number of ways to pair each node with one of the other nodes, and account for duplicates from overcounting A -- B and B -- A.

So a first step in working with this data is to use Gephi's filtering capabilities. Gephi can filter on node or edge attributes. In this case, we would like to filter out the edges corresponding to weaker correlations in the network.

## Using a Statistical Model &mdash; The Gaussian Graphical Model and the GLASSO

In your explorations, you have constructed a sequence of networks with varying strengths of correlations between the stocks. You may have noticed that a lot of the stocks are highly correlated: this is to be expected, since we know that the market tends to move together. However, we also expect to find clusters of stocks that move together more similarly than others, for example stocks in the auto industry, or in the financial sector.

One way to investigate this type of behavior is by introducing a statistical model that tries to capture these relationships. One such model...